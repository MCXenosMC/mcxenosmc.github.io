<!DOCTYPE html>
<html>
<head>
<style>
  body {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    background-image: url("back.jpg");
    background-size: cover;
    background-position: center top;
    font-family: Arial, sans-serif;
  }
  #gameCanvas {
    border: 1px solid black;
    background-color: white;
  }
</style>
</head>
<body>
<canvas id="gameCanvas" width="400" height="400"></canvas>
<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const gridSize = 20;
  let snake = [{ x: 2, y: 2 }];
  let food = [];
  let gameInterval;
  let score = 0;

  const joystickRadius = 30;
  let joystickPosition = { x: canvas.width - 50, y: canvas.height - 50 };

  canvas.addEventListener("mousemove", handleMouseMove);

  function drawJoystick() {
    ctx.strokeStyle = "black";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(joystickPosition.x, joystickPosition.y, joystickRadius, 0, Math.PI * 2);
    ctx.stroke();

    const angle = Math.atan2(mouseY - joystickPosition.y, mouseX - joystickPosition.x);
    const joystickX = joystickPosition.x + Math.cos(angle) * (joystickRadius - 10);
    const joystickY = joystickPosition.y + Math.sin(angle) * (joystickRadius - 10);

    ctx.fillStyle = "black";
    ctx.beginPath();
    ctx.arc(joystickX, joystickY, 10, 0, Math.PI * 2);
    ctx.fill();
  }

  function drawSnake() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    snake.forEach(segment => {
      ctx.fillStyle = "blue";
      ctx.beginPath();
      ctx.arc(segment.x * gridSize + gridSize / 2, segment.y * gridSize + gridSize / 2, gridSize / 2, 0, Math.PI * 2);
      ctx.fill();
    });
  }

  function drawFood() {
    ctx.fillStyle = "red";
    food.forEach(f => {
      ctx.beginPath();
      ctx.arc(f.x * gridSize + gridSize / 2, f.y * gridSize + gridSize / 2, gridSize / 2, 0, Math.PI * 2);
      ctx.fill();
    });
  }

  function drawScore() {
    ctx.fillStyle = "black";
    ctx.font = "20px Arial";
    ctx.fillText(`分数: ${score}`, canvas.width - 100, 30);
  }

  function moveSnake() {
    const newHead = { ...snake[0] };

    const angle = Math.atan2(joystickPosition.y - newHead.y * gridSize - gridSize / 2, joystickPosition.x - newHead.x * gridSize - gridSize / 2);
    newHead.x += Math.cos(angle);
    newHead.y += Math.sin(angle);

    snake.unshift(newHead);

    if (food.some(f => f.x === newHead.x && f.y === newHead.y)) {
      score += 1;
      food = food.filter(f => f.x !== newHead.x || f.y !== newHead.y);
      generateFood();
    } else if (snake.length > score + 1) {
      snake.pop();
    }

    drawSnake();
    drawFood();
    drawScore();
    drawJoystick();
  }

  function generateFood() {
    if (food.length < 3) {
      const newFood = {
        x: Math.floor(Math.random() * (canvas.width / gridSize)),
        y: Math.floor(Math.random() * (canvas.height / gridSize))
      };
      food.push(newFood);
    }
  }

  function checkCollision() {
    const head = snake[0];

    if (
      head.x < 0 ||
      head.y < 0 ||
      head.x >= canvas.width / gridSize ||
      head.y >= canvas.height / gridSize
    ) {
      clearInterval(gameInterval);
      alert("你真菜!");
    }

    for (let i = 1; i < snake.length; i++) {
      if (snake[i].x === head.x && snake[i].y === head.y) {
        clearInterval(gameInterval);
        alert("你真菜!");
        break;
      }
    }
  }

  let mouseX = canvas.width / 2;
  let mouseY = canvas.height / 2;

  function handleMouseMove(event) {
    const canvasRect = canvas.getBoundingClientRect();
    mouseX = event.clientX - canvasRect.left;
    mouseY = event.clientY - canvasRect.top;

    // 限制鼠标位置在手柄圆圈内
    const distance = Math.sqrt((mouseX - joystickPosition.x) ** 2 + (mouseY - joystickPosition.y) ** 2);
    if (distance > joystickRadius) {
      const angle = Math.atan2(mouseY - joystickPosition.y, mouseX - joystickPosition.x);
      mouseX = joystickPosition.x + Math.cos(angle) * joystickRadius;
      mouseY = joystickPosition.y + Math.sin(angle) * joystickRadius;
    }
  }

  function startGame() {
    generateFood();
    gameInterval = setInterval(() => {
      moveSnake();
      checkCollision();
    }, 1000 / 60); // 提高到60帧
  }

  startGame();
</script>
</body>
</html>
